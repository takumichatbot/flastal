// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---

// ↓↓↓ 【NotificationType Enum】
enum NotificationType {
  NEW_PLEDGE
  NEW_CHAT_MESSAGE
  NEW_ANNOUNCEMENT
  OFFER_STATUS_UPDATE
  QUOTATION_APPROVED
  TASK_ASSIGNED
  PROJECT_STATUS_UPDATE
}

// ↑↑↑ NotificationType Enum ↑↑↑

enum ProjectStatus {
  PENDING_APPROVAL
  FUNDRAISING
  SUCCESSFUL
  PROCESSING
  READY_FOR_DELIVERY
  COMPLETED
  CANCELED
  REJECTED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum FloristStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MessageSenderType {
  USER
  FLORIST
}

enum MessageType {
  TEXT
  IMAGE
  FILE
}

enum ProjectVisibility {
  PUBLIC
  UNLISTED
}

enum UserRole {
  USER
  ADMIN
}

// --- Models ---

// ↓↓↓ 【Notification Model】: User/Projectモデルの前に定義
model Notification {
  id          String           @id @default(cuid())
  recipientId String // 受信者 (User)
  type        NotificationType
  isRead      Boolean          @default(false)
  message     String           @db.Text // 通知メッセージ本体
  linkUrl     String? // クリック時の遷移先URL
  createdAt   DateTime         @default(now())

  // Relations
  recipient User?    @relation("UserNotifications", fields: [recipientId], references: [id])
  projectId String?
  project   Project? @relation("ProjectNotifications", fields: [projectId], references: [id])
}

// ↑↑↑ Notification Model ↑↑↑

model User {
  id                   String       @id @default(cuid())
  email                String       @unique
  handleName           String
  password             String
  points               Int          @default(0)
  reviewLikes          ReviewLike[]
  role                 UserRole     @default(USER)
  iconUrl              String?
  referralCode         String       @unique @default(cuid())
  referredById         String?
  hasMadeFirstPurchase Boolean      @default(false)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  // Relations
  referrer          User?                      @relation("Referrals", fields: [referredById], references: [id])
  referredUsers     User[]                     @relation("Referrals")
  createdProjects   Project[]                  @relation("PlannerProjects")
  pledges           Pledge[]
  reviews           Review[]
  messages          Message[]
  groupChatMessages GroupChatMessage[]
  pollVotes         PollVote[]
  reports           ProjectReport[]            @relation("UserReports")
  sentChatMessages  ChatMessage[]              @relation("UserChatMessages")
  addedVenues       Venue[]                    @relation("UserAddedVenues")
  assignedTasks     Task[]                     @relation("AssignedTasks")
  notifications     Notification[]             @relation("UserNotifications") // 参照OK
  chatReactions     GroupChatMessageReaction[]
}

model Project {
  id                      String            @id @default(cuid())
  title                   String
  description             String            @db.Text
  targetAmount            Int
  collectedAmount         Int               @default(0)
  deliveryAddress         String
  deliveryDateTime        DateTime
  imageUrl                String?
  designDetails           String?           @db.Text
  size                    String?
  flowerTypes             String?
  status                  ProjectStatus     @default(PENDING_APPROVAL)
  visibility              ProjectVisibility @default(PUBLIC)
  completionImageUrls     String[]
  completionComment       String?           @db.Text
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  finalBalance            Int?
  surplusUsageDescription String?           @db.Text
  venueId                 String?
  venue                   Venue?            @relation(fields: [venueId], references: [id])

  // Relations
  plannerId         String
  planner           User               @relation("PlannerProjects", fields: [plannerId], references: [id])
  pledges           Pledge[]
  offer             Offer?
  review            Review?
  announcements     Announcement[]
  expenses          Expense[]
  commission        Commission?
  quotation         Quotation?
  messages          Message[]
  tasks             Task[]
  groupChatMessages GroupChatMessage[]
  activePoll        ActivePoll?
  reports           ProjectReport[]
  pledgeTiers       PledgeTier[]
  notifications     Notification[]     @relation("ProjectNotifications") // 参照OK
}

model PledgeTier {
  id          String   @id @default(cuid())
  amount      Int
  title       String
  description String   @db.Text
  createdAt   DateTime @default(now())

  // Relations
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  pledges   Pledge[]
}

model Pledge {
  id        String   @id @default(cuid())
  amount    Int
  comment   String?
  createdAt DateTime @default(now())

  // Relations
  projectId    String
  project      Project     @relation(fields: [projectId], references: [id])
  userId       String
  user         User        @relation(fields: [userId], references: [id])
  pledgeTierId String?
  pledgeTier   PledgeTier? @relation(fields: [pledgeTierId], references: [id])
}

model Florist {
  id              String        @id @default(cuid())
  email           String        @unique
  password        String
  contactName     String
  portfolioImages String[]
  address         String?
  phoneNumber     String?
  website         String?
  portfolio       String?       @db.Text
  businessHours   String?       @db.Text
  balance         Int           @default(0)
  laruBotApiKey   String?
  iconUrl         String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  shopName        String
  platformName    String        @unique
  status          FloristStatus @default(PENDING)

  // Relations
  offers           Offer[]
  reviews          Review[]
  payoutRequests   PayoutRequest[]
  sentChatMessages ChatMessage[]   @relation("FloristChatMessages")
}

model Offer {
  id        String      @id @default(cuid())
  status    OfferStatus @default(PENDING)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  projectId String    @unique
  project   Project   @relation(fields: [projectId], references: [id])
  floristId String
  florist   Florist   @relation(fields: [floristId], references: [id])
  chatRoom  ChatRoom?
}

model ChatRoom {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  offerId  String        @unique
  offer    Offer         @relation(fields: [offerId], references: [id])
  messages ChatMessage[]
}

model ChatMessage {
  id String @id @default(cuid())

  messageType MessageType @default(TEXT)
  fileUrl     String?
  fileName    String?

  content String? @db.Text

  senderType     MessageSenderType
  isAutoResponse Boolean           @default(false)
  createdAt      DateTime          @default(now())

  // Relations
  chatRoomId String
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id])
  userId     String?
  user       User?    @relation("UserChatMessages", fields: [userId], references: [id])
  floristId  String?
  florist    Florist? @relation("FloristChatMessages", fields: [floristId], references: [id])
}

model Venue {
  id          String    @id @default(cuid())
  email       String?   @unique
  password    String?
  venueName   String
  address     String?
  regulations String?   @db.Text
  isOfficial  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  addedById   String?
  addedBy     User?     @relation("UserAddedVenues", fields: [addedById], references: [id])
  projects    Project[]
}

model Review {
  id        String   @id @default(cuid())
  comment   String?  @db.Text
  createdAt DateTime @default(now())

  // Relations
  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id])
  floristId String
  florist   Florist @relation(fields: [floristId], references: [id])
  userId    String
  user      User    @relation(fields: [userId], references: [id])

  likes ReviewLike[]
}

model ReviewLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  reviewId String
  review   Review @relation(fields: [reviewId], references: [id])
  userId   String
  user     User   @relation(fields: [userId], references: [id])

  @@unique([reviewId, userId])
}

model Commission {
  id        String   @id @default(cuid())
  amount    Int
  createdAt DateTime @default(now())

  // Relations
  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id])
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  createdAt DateTime @default(now())

  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id])
}

model PayoutRequest {
  id          String   @id @default(cuid())
  amount      Int
  accountInfo String   @db.Text
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  floristId String
  florist   Florist @relation(fields: [floristId], references: [id])
}

model Expense {
  id        String   @id @default(cuid())
  itemName  String
  amount    Int
  createdAt DateTime @default(now())

  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id])
}

model Quotation {
  id          String    @id @default(cuid())
  totalAmount Int
  isApproved  Boolean   @default(false)
  isFinalized Boolean   @default(false)
  finalizedAt DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  projectId String          @unique
  project   Project         @relation(fields: [projectId], references: [id])
  items     QuotationItem[]
}

model QuotationItem {
  id       String @id @default(cuid())
  itemName String
  amount   Int

  // Relations
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id])
}

model Task {
  id          String    @id @default(cuid())
  title       String
  isCompleted Boolean   @default(false)
  dueDate     DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  projectId      String
  project        Project @relation(fields: [projectId], references: [id])
  assignedUserId String?
  assignedUser   User?   @relation("AssignedTasks", fields: [assignedUserId], references: [id])
}

model Message {
  id        String   @id @default(cuid())
  content   String   @db.Text
  cardName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projectId String
  project   Project @relation(fields: [projectId], references: [id])
  userId    String
  user      User    @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
}

model GroupChatMessage {
  id String @id @default(cuid())

  messageType MessageType @default(TEXT)
  fileUrl     String?
  fileName    String?

  templateId String?
  content    String?
  createdAt  DateTime @default(now())

  // Relations
  projectId String
  project   Project                    @relation(fields: [projectId], references: [id])
  userId    String
  user      User                       @relation(fields: [userId], references: [id])
  reactions GroupChatMessageReaction[]
}

model GroupChatMessageReaction {
  id        String   @id @default(cuid())
  emoji     String
  createdAt DateTime @default(now())

  // Relations
  messageId String
  message   GroupChatMessage @relation(fields: [messageId], references: [id])
  userId    String
  user      User             @relation(fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
}

model ActivePoll {
  id        String   @id @default(cuid())
  question  String
  options   String[]
  createdAt DateTime @default(now())

  // Relations
  projectId String     @unique
  project   Project    @relation(fields: [projectId], references: [id])
  votes     PollVote[]
}

model PollVote {
  id          String @id @default(cuid())
  optionIndex Int

  // Relations
  pollId String
  poll   ActivePoll @relation(fields: [pollId], references: [id])
  userId String
  user   User       @relation(fields: [userId], references: [id])

  @@unique([pollId, userId])
}

model ProjectReport {
  id        String   @id @default(cuid())
  reason    String
  details   String?  @db.Text
  status    String   @default("SUBMITTED")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  projectId  String
  project    Project @relation(fields: [projectId], references: [id])
  reporterId String
  reporter   User    @relation("UserReports", fields: [reporterId], references: [id])

  @@unique([projectId, reporterId])
}
