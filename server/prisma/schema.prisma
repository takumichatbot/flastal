// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Enums ---

enum ProductionStatus {
  NOT_STARTED // 未着手
  FLORIST_MATCHED // 花屋決定・相談中
  DESIGN_FIXED // デザイン決定
  PANELS_RECEIVED // パネル受取完了
  IN_PRODUCTION // 制作中
  PRE_COMPLETION // 前日写真アップ
  COMPLETED // 当日設置完了
}

enum PostType {
  SUCCESS_STORY     // 企画者による成功報告
  PLEDGER_THANKS    // 支援者によるお礼コメント
  FLORIST_APPEAL    // お花屋さんによるアピール
}

enum ProjectType {
  PUBLIC // みんなで（通常）
  PRIVATE // 限定公開（合言葉が必要）
  SOLO // 自分ひとり（一覧に載せない）
}

enum NotificationType {
  NEW_PLEDGE
  NEW_CHAT_MESSAGE
  NEW_ANNOUNCEMENT
  OFFER_STATUS_UPDATE
  QUOTATION_APPROVED
  TASK_ASSIGNED
  PROJECT_STATUS_UPDATE
  PROJECT_APPROVED
}

enum ProjectStatus {
  PENDING_APPROVAL
  FUNDRAISING
  SUCCESSFUL
  PROCESSING
  READY_FOR_DELIVERY
  COMPLETED
  CANCELED
  REJECTED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum FloristStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MessageSenderType {
  USER
  FLORIST
}

enum MessageType {
  TEXT
  IMAGE
  FILE
}

enum ProjectVisibility {
  PUBLIC
  UNLISTED
}

enum UserRole {
  USER
  ADMIN
}

enum EventSource {
  OFFICIAL // イベント会社・主催者が登録
  USER // 一般ユーザーが登録
  AI // AIがWebから取得
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

// --- Models ---

model Notification {
  id          String           @id @default(cuid())
  recipientId String
  type        NotificationType
  isRead      Boolean          @default(false)
  message     String           @db.Text
  linkUrl     String?
  createdAt   DateTime         @default(now())

  // Relations
  recipient User     @relation("UserNotifications", fields: [recipientId], references: [id])
  projectId String?
  project   Project? @relation("ProjectNotifications", fields: [projectId], references: [id])
}

model User {
  id                   String             @id @default(cuid())
  email                String             @unique
  handleName           String
  password             String
  points               Int                @default(0)
  reviewLikes          ReviewLike[]
  role                 UserRole           @default(USER)
  iconUrl              String?
  referralCode         String             @unique @default(cuid())
  pushSubscriptions    PushSubscription[]
  referredById         String?
  posts         ProjectPost[]
  hasMadeFirstPurchase Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  bio                  String?
  favoriteGenres       String[]
  twitterUrl           String?
  instagramUrl         String?
  isProfilePublic      Boolean            @default(true)
  totalPledgedAmount Int?      @default(0) // 総支援額を格納 (Intにすると桁数オーバーの可能性もあるため、BigIntも検討可)
  supportLevel       String?   // 現在のレベル名 (例: Bronze, Gold)
  badgeIds           String[]  // 獲得したバッジIDの配列 (現状はバッジマスタがないため、String[]で対応)

  // Relations
  referrer          User?                      @relation("Referrals", fields: [referredById], references: [id])
  referredUsers     User[]                     @relation("Referrals")
  createdProjects   Project[]                  @relation("PlannerProjects")
  pledges           Pledge[]
  reviews           Review[]
  messages          Message[]
  groupChatMessages GroupChatMessage[]
  pollVotes         PollVote[]
  reports           ProjectReport[]            @relation("UserReports")
  sentChatMessages  ChatMessage[]              @relation("UserChatMessages")
  addedVenues       Venue[]                    @relation("UserAddedVenues")
  assignedTasks     Task[]                     @relation("AssignedTasks")
  notifications     Notification[]             @relation("UserNotifications")
  chatReactions     GroupChatMessageReaction[]

  // ★★★ ここを追加（通報リレーション） ★★★
  eventReports            EventReport[]
  groupChatMessageReports GroupChatMessageReport[]
  chatMessageReports      ChatMessageReport[]
  Post                    Post[]
}

model Project {
  id                      String            @id @default(cuid())
  title                   String
  description             String            @db.Text
  targetAmount            Int
  collectedAmount         Int               @default(0)
  deliveryAddress         String
  deliveryDateTime        DateTime
  imageUrl                String?
  designDetails           String?           @db.Text
  size                    String?
  flowerTypes             String?
  status                  ProjectStatus     @default(PENDING_APPROVAL)
  visibility              ProjectVisibility @default(PUBLIC)
  completionImageUrls     String[]
  completionComment       String?           @db.Text
  createdAt               DateTime          @default(now())
  eventId                 String?
  successPosts  ProjectPost[]
  event                   Event?            @relation(fields: [eventId], references: [id])
  updatedAt               DateTime          @updatedAt
  finalBalance            Int?
  surplusUsageDescription String?           @db.Text
  venueId                 String?
  designImageUrls         String[]
  venue                   Venue?            @relation(fields: [venueId], references: [id])
  productionStatus        ProductionStatus  @default(NOT_STARTED)

  illustrationPanelUrls String[]
  messagePanelUrls      String[]
  sponsorPanelUrls      String[]
  preEventPhotoUrls     String[]

  plannerId         String
  planner           User               @relation("PlannerProjects", fields: [plannerId], references: [id])
  pledges           Pledge[]
  offer             Offer?
  review            Review?
  announcements     Announcement[]
  expenses          Expense[]
  commission        Commission?
  quotation         Quotation?
  messages          Message[]
  tasks             Task[]
  groupChatMessages GroupChatMessage[]
  activePoll        ActivePoll?
  reports           ProjectReport[]
  pledgeTiers       PledgeTier[]
  notifications     Notification[]     @relation("ProjectNotifications")
  projectType       ProjectType        @default(PUBLIC)
  password          String?
}

model PledgeTier {
  id          String   @id @default(cuid())
  amount      Int
  title       String
  description String   @db.Text
  createdAt   DateTime @default(now())

  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  pledges   Pledge[]
}

model Pledge {
  id        String   @id @default(cuid())
  amount    Int
  comment   String?
  createdAt DateTime @default(now())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  guestName  String?
  guestEmail String?

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  pledgeTierId String?
  pledgeTier   PledgeTier? @relation(fields: [pledgeTierId], references: [id])
}

model Florist {
  id                String        @id @default(cuid())
  email             String        @unique
  password          String
  contactName       String
  portfolioImages   String[]
  address           String?
  phoneNumber       String?
  acceptsRushOrders Boolean       @default(false)
  website           String?
  portfolio         String?       @db.Text
  businessHours     String?       @db.Text
  balance           Int           @default(0)
  laruBotApiKey     String?
  specialties       String[]
  iconUrl           String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  shopName          String
  platformName      String        @unique
  status            FloristStatus @default(PENDING)

  offers           Offer[]
  reviews          Review[]
  payoutRequests   PayoutRequest[]
  sentChatMessages ChatMessage[]        @relation("FloristChatMessages")
  postedLogistics  VenueLogisticsInfo[]
}

model Offer {
  id        String      @id @default(cuid())
  status    OfferStatus @default(PENDING)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  projectId String    @unique
  project   Project   @relation(fields: [projectId], references: [id])
  floristId String
  florist   Florist   @relation(fields: [floristId], references: [id])
  chatRoom  ChatRoom?
}

model ChatRoom {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  offerId  String        @unique
  offer    Offer         @relation(fields: [offerId], references: [id])
  messages ChatMessage[]
}

model ChatMessage {
  id             String            @id @default(cuid())
  messageType    MessageType       @default(TEXT)
  fileUrl        String?
  fileName       String?
  content        String?           @db.Text
  senderType     MessageSenderType
  isAutoResponse Boolean           @default(false)
  createdAt      DateTime          @default(now())

  chatRoomId String
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id])
  userId     String?
  user       User?    @relation("UserChatMessages", fields: [userId], references: [id])
  floristId  String?
  florist    Florist? @relation("FloristChatMessages", fields: [floristId], references: [id])

  // ★★★ ここを追加（通報リレーション） ★★★
  reports ChatMessageReport[]
}

model Venue {
  id         String  @id @default(cuid())
  venueName  String
  address    String?
  email      String  @unique
  password   String
  isOfficial Boolean @default(false)

  isStandAllowed    Boolean? @default(true)
  standRegulation   String?
  isBowlAllowed     Boolean? @default(true)
  bowlRegulation    String?
  retrievalRequired Boolean? @default(true)
  accessInfo        String?
  regulations       String?

  websiteUrl   String?
  phoneNumber  String?
  twitterUrl   String?
  instagramUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events         Event[]
  projects       Project[]
  logisticsInfos VenueLogisticsInfo[]

  addedById String?
  addedBy   User?   @relation("UserAddedVenues", fields: [addedById], references: [id])
}

model Review {
  id        String   @id @default(cuid())
  comment   String?  @db.Text
  createdAt DateTime @default(now())

  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id])
  floristId String
  florist   Florist @relation(fields: [floristId], references: [id])
  userId    String
  user      User    @relation(fields: [userId], references: [id])

  likes ReviewLike[]
}

model ReviewLike {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  reviewId String
  review   Review @relation(fields: [reviewId], references: [id])
  userId   String
  user     User   @relation(fields: [userId], references: [id])

  @@unique([reviewId, userId])
}

model Commission {
  id        String   @id @default(cuid())
  amount    Int
  createdAt DateTime @default(now())

  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id])
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String   @db.Text
  createdAt DateTime @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id])
}

model PayoutRequest {
  id          String   @id @default(cuid())
  amount      Int
  accountInfo String   @db.Text
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  floristId String
  florist   Florist @relation(fields: [floristId], references: [id])
}

model Expense {
  id        String   @id @default(cuid())
  itemName  String
  amount    Int
  createdAt DateTime @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id])
}

model Quotation {
  id          String    @id @default(cuid())
  totalAmount Int
  isApproved  Boolean   @default(false)
  isFinalized Boolean   @default(false)
  finalizedAt DateTime?
  createdAt   DateTime  @default(now())

  projectId String          @unique
  project   Project         @relation(fields: [projectId], references: [id])
  items     QuotationItem[]
}

model QuotationItem {
  id       String @id @default(cuid())
  itemName String
  amount   Int

  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id])
}

model Task {
  id          String    @id @default(cuid())
  title       String
  isCompleted Boolean   @default(false)
  dueDate     DateTime?
  createdAt   DateTime  @default(now())

  projectId      String
  project        Project @relation(fields: [projectId], references: [id])
  assignedUserId String?
  assignedUser   User?   @relation("AssignedTasks", fields: [assignedUserId], references: [id])
}

model Message {
  id        String   @id @default(cuid())
  content   String   @db.Text
  cardName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projectId String
  project   Project @relation(fields: [projectId], references: [id])
  userId    String
  user      User    @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
}

model GroupChatMessage {
  id          String      @id @default(cuid())
  messageType MessageType @default(TEXT)
  fileUrl     String?
  fileName    String?
  templateId  String?
  content     String?
  createdAt   DateTime    @default(now())

  projectId String
  project   Project                    @relation(fields: [projectId], references: [id])
  userId    String
  user      User                       @relation(fields: [userId], references: [id])
  reactions GroupChatMessageReaction[]

  // ★★★ ここを追加（通報リレーション） ★★★
  reports GroupChatMessageReport[]
}

model GroupChatMessageReaction {
  id        String   @id @default(cuid())
  emoji     String
  createdAt DateTime @default(now())

  messageId String
  message   GroupChatMessage @relation(fields: [messageId], references: [id])
  userId    String
  user      User             @relation(fields: [userId], references: [id])

  @@unique([messageId, userId, emoji])
}

model ActivePoll {
  id        String   @id @default(cuid())
  question  String
  options   String[]
  createdAt DateTime @default(now())

  projectId String     @unique
  project   Project    @relation(fields: [projectId], references: [id])
  votes     PollVote[]
}

model PollVote {
  id          String @id @default(cuid())
  optionIndex Int

  pollId String
  poll   ActivePoll @relation(fields: [pollId], references: [id])
  userId String
  user   User       @relation(fields: [userId], references: [id])

  @@unique([pollId, userId])
}

model ProjectReport {
  id        String   @id @default(cuid())
  reason    String
  details   String?  @db.Text
  status    String   @default("SUBMITTED")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projectId  String
  project    Project @relation(fields: [projectId], references: [id])
  reporterId String
  reporter   User    @relation("UserReports", fields: [reporterId], references: [id])

  @@unique([projectId, reporterId])
}

model Organizer {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  website   String?
  events    Event[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Post {
  id            String   @id @default(cuid())
  eventName     String
  senderName    String?
  recipientName String? // 今回追加した宛名
  imageUrl      String
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())

  @@index([userId])
}

model Event {
  id             String   @id @default(cuid())
  title          String
  description    String?
  eventDate      DateTime
  isStandAllowed Boolean  @default(true)
  regulationNote String?
  imageUrl       String?

  // ★★★ 変更: organizerId をオプショナルに ★★★
  organizerId String?
  organizer   Organizer? @relation(fields: [organizerId], references: [id])

  venueId String?
  venue   Venue?  @relation(fields: [venueId], references: [id])

  projects Project[]

  sourceType EventSource @default(USER)
  sourceUrl  String?
  isBanned   Boolean     @default(false)

  reports EventReport[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
}

model VenueLogisticsInfo {
  id      String @id @default(cuid())
  venueId String
  venue   Venue  @relation(fields: [venueId], references: [id], onDelete: Cascade)

  contributorId String
  contributor   Florist @relation(fields: [contributorId], references: [id])

  title       String
  description String
  imageUrls   String[]

  isOfficial Boolean @default(false)

  helpfulCount Int @default(0)

  createdAt DateTime @default(now())
}

model EventReport {
  id         String       @id @default(uuid())
  eventId    String
  event      Event        @relation(fields: [eventId], references: [id])
  reporterId String
  reporter   User         @relation(fields: [reporterId], references: [id])
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
}

model GroupChatMessageReport {
  id         String           @id @default(uuid())
  messageId  String
  message    GroupChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  reporterId String
  reporter   User             @relation(fields: [reporterId], references: [id])
  reason     String
  status     ReportStatus     @default(PENDING)
  createdAt  DateTime         @default(now())
}

model ChatMessageReport {
  id         String       @id @default(uuid())
  messageId  String
  message    ChatMessage  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  reporterId String
  reporter   User         @relation(fields: [reporterId], references: [id])
  reason     String
  status     ReportStatus @default(PENDING)
  createdAt  DateTime     @default(now())
}


model ProjectPost {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  content     String   @db.Text
  postType    PostType @default(SUCCESS_STORY)
  isApproved  Boolean  @default(true) // 管理者承認 (初期は承認済みとする)
  createdAt   DateTime @default(now())

  // Relations
  project     Project  @relation(fields: [projectId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  // 企画ごとにユーザーの投稿を重複させない（任意）
  @@unique([projectId, userId, postType]) 
}